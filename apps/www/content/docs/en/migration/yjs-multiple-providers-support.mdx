---
title: Migrating to Multi-Provider Yjs
description: Learn how to migrate from single-provider Hocuspocus to multi-provider Yjs implementation.
---

## Overview

In previous versions of Plate's Yjs plugin, only the Hocuspocus provider was supported. The new version has been enhanced to support multiple providers simultaneously, including:

- **Hocuspocus** for server-based collaboration
- **WebRTC** for peer-to-peer collaboration
- **Custom providers** for additional functionality

This guide will help you migrate from the previous implementation to the new multi-provider system.

## 1. Update Dependencies

First, make sure you have the latest version of the Plate Yjs plugin:

```bash
npm install @udecode/plate-yjs@latest
```

Then, install only the providers you need:

```bash
# For Hocuspocus (if you were already using it)
npm install @hocuspocus/provider

# For WebRTC (if you want peer-to-peer)
npm install y-webrtc
```

## 2. Update Configuration

The main change is migrating from `hocuspocusProviderOptions` to the new `providerConfigs` array.

### Before:

```tsx
YjsPlugin.configure({
  options: {
    cursorOptions: {
      autoSend: true,
      data: { name: 'User', color: '#5AC990' },
    },
    disableCursors: false,
    hocuspocusProviderOptions: {
      url: 'wss://hocuspocus.example.com',
      name: 'document-1',
      // Other Hocuspocus options...
    },
  },
})
```

### After:

```tsx
YjsPlugin.configure({
  options: {
    cursorOptions: {
      autoSend: true,
      data: { name: 'User', color: '#5AC990' },
    },
    disableCursors: false,
    providerConfigs: [
      {
        type: 'hocuspocus',
        options: {
          url: 'wss://hocuspocus.example.com',
          name: 'document-1',
          // Other Hocuspocus options...
        },
      },
      // Optional additional providers:
      // {
      //   type: 'webrtc',
      //   options: {
      //     roomName: 'document-1',
      //   },
      // },
    ],
    // Optional setting to wait for all providers to sync
    waitForAllProviders: false, // Default is false
  },
})
```

## 3. Access Provider Instances

If you were accessing the provider instance directly, the way you do this has changed:

### Before:

```tsx
// Accessing the Hocuspocus provider
const provider = editor.getOption(YjsPlugin, 'yjs.provider');

// Checking connection status
const isConnected = provider.isConnected;
```

### After:

```tsx
// Accessing all providers
const providers = editor.getOption(YjsPlugin, 'providers');

// Get the Hocuspocus provider specifically
const hocuspocusProvider = providers.find(p => p.type === 'hocuspocus');

// Access properties on specific providers
if (hocuspocusProvider) {
  const isConnected = hocuspocusProvider.isConnected;
}
```

## 4. Update State Tracking

The state tracking has been enhanced to better support multiple providers:

### Before:

```tsx
// Using the useYjsStore hook
const { isConnected, isSynced } = useYjsStore();

// Rendering content when synced
if (!isSynced) {
  return <p>Loading...</p>;
}
```

### After:

```tsx
// Using the enhanced useYjsStore hook
const { 
  isConnected, 
  syncedProviderCount,
  totalProviderCount 
} = useYjsStore();

// Basic rendering when any provider is synced (same behavior as before)
if (syncedProviderCount === 0) {
  return <p>Loading...</p>;
}

// For applications that want to wait for all providers:
const allProvidersSync = syncedProviderCount >= totalProviderCount;
if (!allProvidersSync) {
  return <p>Synchronizing all providers...</p>;
}
```

## 5. Adding WebRTC Support

To add peer-to-peer collaboration with WebRTC alongside your existing Hocuspocus setup:

```tsx
YjsPlugin.configure({
  options: {
    // Your existing cursor options...
    cursorOptions: { /* ... */ },
    disableCursors: false,
    providerConfigs: [
      // Keep your existing Hocuspocus provider
      {
        type: 'hocuspocus',
        options: {
          url: 'wss://hocuspocus.example.com',
          name: 'document-1',
        },
      },
      // Add WebRTC provider for peer-to-peer
      {
        type: 'webrtc',
        options: {
          roomName: 'document-1', // Should match the document name
          // Optional: custom signaling servers
          // signaling: ['wss://signaling.example.com'],
        },
      },
    ],
  },
})
```

## 6. Testing Multi-Provider Setup

When testing your application with multiple providers:

1. **Test fallback scenarios**: Disable your Hocuspocus server to ensure WebRTC takes over
2. **Check sync behavior**: Test how your app behaves when providers connect and disconnect
3. **Verify waitForAllProviders**: If you set this option, ensure content appears only when all providers are synced

## Common Issues and Troubleshooting

### Provider Not Connecting

Make sure your provider configuration is correct:

```tsx
// For Hocuspocus
{
  type: 'hocuspocus',
  options: {
    url: 'ws://localhost:1234', // Check this URL
    name: 'document-name', 
  },
}

// For WebRTC
{
  type: 'webrtc',
  options: {
    roomName: 'document-name', // Must match between peers
    // For custom signaling servers:
    // signaling: ['ws://signaling.example.com'], 
  },
}
```

### Multiple Documents

If you're working with multiple documents:

```tsx
// Create a unique Y.Doc for each document
const ydoc = new Y.Doc();

// Pass it to your provider config
YjsPlugin.configure({
  options: {
    ydoc,
    providerConfigs: [
      {
        type: 'hocuspocus',
        options: {
          name: documentId, // Unique document ID
          url: 'ws://localhost:1234',
        },
      },
      {
        type: 'webrtc',
        options: {
          roomName: documentId, // Same unique document ID
        },
      },
    ],
  },
})
```